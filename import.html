<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importeer magister cijfers</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: min(2vw, 2em);
            margin: 1em;
        }

        .instructions {
            flex: 1;
            line-height: 1.6;
        }
        
        .demo {
            width: 20em;
            height: auto;
        }

        h1 {
            font-size: 1.2em;
        }

        kbd {
            background-color: #eee;
            border-radius: .1em;
            border: 1px solid #b4b4b4;
            color: #333;
            font-size: .85em;
            font-weight: 700;
            line-height: 1;
            white-space: nowrap;
        }

        .magister_results {
            border-collapse: collapse;
        }

        td {
            border: .06em solid blue;
        }

        .errors {
            background-color: lightcoral;
            color: crimson;
            font-weight: 700;
            line-height: 1.6;
            padding: .1em .5em;
            white-space: pre-wrap;
        }
    </style>

    <script src="d3.v7.min.js"></script>

    <script src="data.js" defer></script>
    <script src="results.js" defer></script>
    <script defer>
        let errors = [];
        function set_error(msg) {
            console.error(msg);
            errors.push(msg);

            d3.select('.errors')
                .style('display', 'block')
                .text(errors.join('\n'));
        }

        function get_id_by_magister(magister, assignments = schema) {
            for (const assign of assignments) {
                if (assign.magister === magister) {
                    return assign.id;
                }
                if (assign.assignments) {
                    let res = get_id_by_magister(magister, assign.assignments);
                    if (res) {
                        return res;
                    }
                }
            }
        }

        document.addEventListener('paste', function (e) {
            e.preventDefault();

            try {
                let pastedText = e.clipboardData.getData('text/html');
                let magister_results = [...pastedText.matchAll(/<span\s+id="([A-Z]+)_[\d\.]+_(\d+)"\s+title="(\d+,\d+)"[\s\n]/g)];  // /<span\s+id="(WISB|WISD|NAT|SCHK|BIOL|ANW|NLT|MAAT|CKV|NETL|ENTL|SPTL|FI|LO)_[\d\.]+_(\d+)"\s+title="(\d+,\d+)"[\s\n]/g
                if (magister_results.length === 0) {
                    set_error("Kon geen resultaten vinden op het klipbord");
                }
                load_results();

                d3.select('.magister_results').selectChildren().remove();
                for (const magister_result of magister_results) {
                    let magister = magister_result[1] + magister_result[2];
                    let id = get_id_by_magister(magister);
                    let score = parseFloat(magister_result[3].replace(',', '.'));

                    let row = d3.select('.magister_results')
                        .append('tr');
                    row.append('td')
                        .text(magister);
                    row.append('td')
                        .text(score);
                    /* row.append('td')
                        .text(get_id_by_magister(magister)); */

                    results[id] = score;  // TODO: nl number
                }
                save_results();

            } catch (error) {
                set_error(error.stack);
            }
        });


        window.onload = () => {
            d3.select('.errors')
                .style('display', 'none');
        }

    </script>
</head>

<body>
    <div class="errors"></div>
    <div style="display: flex; gap: 1em;">
        <div class="instructions">
            <h1>Resultaten importeren uit magister</h1>
            <ol>
                <li>Ga naar je magister cijfers</li>
                <li>Klik op "Bekijk cijferoverzicht"</li>
                <li>Onder <strong>Cijfersoort</strong> bij <strong>Weergave</strong> selecteer <strong>PTA -
                        kolommen</strong></li>
                <li>Selecteer alles op de pagina met de toetsencombinatie <kbd>Ctrl</kbd>+<kbd>a</kbd> (<span
                        class="kbdcb"><kbd>âŒ˜
                            Command</kbd>+<kbd>a</kbd></span> voor Apple producten)</li>
                <li>Kopieer het geselecteerde naar je klipbord met de toetsencombinatie <kbd>Ctrl</kbd>+<kbd>c</kbd>
                </li>
                <li>Ga terug naar deze pagina</li>
                <li>Laad je resultaten door ze te plakken op deze pagina met <kbd>Ctrl</kbd>+<kbd>v</kbd></li>
                <li><a href="./">Ga terug</a> naar de hoofdpagina</li>
            </ol>
        </div>
        <img src="demo.gif" class="demo" alt="Voorbeeld van het importeren van magister cijfers">
        <table class="magister_results"></table>
    </div>
</body>

</html>
